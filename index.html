<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Tap to million.</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; background: #000; color: #fff; font-family: system-ui, -apple-system, sans-serif; overflow: hidden; touch-action: none; -webkit-user-select: none; user-select: none; }
    #container { height: 100%; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
    #display-area { text-align: center; width: 100%; }
    #target-text { font-size: 14px; color: #ff3b30; font-weight: 900; letter-spacing: 2px; margin-bottom: 10px; opacity: 0.8; }
    #number { font-size: 80px; font-weight: 900; line-height: 1; font-variant-numeric: tabular-nums; }
    #message { font-size: 13px; color: #444; font-weight: 900; height: 24px; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; }
    #progress-bar { position: fixed; top: 0; left: 0; height: 3px; background: #ff3b30; width: 0%; z-index: 1000; }
    #final-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; box-sizing: border-box; }
    #philosophy { font-size: 16px; line-height: 2.2; color: #777; font-weight: 300; letter-spacing: 0.1em; opacity: 0; transition: opacity 1.5s; }
    .ichie { color: #555; font-style: normal; }
    .tap-anim { animation: tap-pulse 0.06s cubic-bezier(0, 0, 0.2, 1); }
    @keyframes tap-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
  </style>
</head>
<body>
  <div id="progress-bar"></div>
  <div id="container">
    <div id="display-area">
      <div id="target-text">TARGET: 1,000,000</div>
      <div id="number">0</div>
      <div id="message"></div>
    </div>
  </div>
  <div id="final-screen"><div id="philosophy"></div></div>

  <script>
    const userLang = navigator.language || navigator.userLanguage;
    const isJapanese = userLang.includes('ja');
    const t = isJapanese ? {
      insults: ["進んでいる気がするだけだ", "数字は動く。意味は動かない", "電気信号の、静かな葬列", "熱はどこにも届かない", "ただ、時間が磨り減っている", "0と1の間に、価値は存在しない", "この振動に、出口はない"],
      final: "あなたが見た数字は、幻だった。<br><br>ここで過ごした時間だけが、<br>そのまま残る。<br><br>この場所は、<br>もう開かない。",
      ichie: "<br><br><br><span class='ichie'>一会あり<br>誰と儚く、<br>誰とはなく、</span>"
    } : {
      insults: ["Progress is an illusion.", "Numbers move. Meaning stays.", "A silent funeral of bits.", "The heat reaches nowhere.", "Time is merely grinding down.", "No value between 0 and 1.", "No exit from this pulse."],
      final: "What you saw<br>was never the point.<br><br>Only the time<br>remains.<br><br>This place<br>will not open again.",
      ichie: "<br><br><br><span class='ichie'>One meeting,<br>brief—<br><br>with someone,<br>or with no one.</span>"
    };

    const LOCK_KEY = "tap_to_million_fixed_v1";
    if (localStorage.getItem(LOCK_KEY)) { window.onload = () => finish(true); }

    let startTime = null, isFinished = false, tapCount = 0;
    const DURATION = 60000, MAX_VAL = 978412;

    // --- 強化版 Brown Noise Engine ---
    let audioCtx, noiseNode, gainNode;

    async function startBrownNoise() {
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      
      // ブラウザのオーディオ再開処理（重要）
      if (audioCtx.state === 'suspended') { await audioCtx.resume(); }

      const bufferSize = 4096;
      let lastOut = 0.0;
      
      noiseNode = audioCtx.createScriptProcessor(bufferSize, 1, 1);
      gainNode = audioCtx.createGain();

      noiseNode.onaudioprocess = (e) => {
        const output = e.outputBuffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
          const white = Math.random() * 2 - 1;
          // ブラウンノイズのアルゴリズムをより安定したものに
          output[i] = (lastOut + (0.02 * white)) / 1.02;
          lastOut = output[i];
          output[i] *= 8.0; // 音量を増幅
        }
      };

      noiseNode.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      // フェードイン
      gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
      gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.2);
    }

    function stopBrownNoise() {
      if (gainNode && audioCtx) {
        gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
        setTimeout(() => { audioCtx.close(); }, 200);
      }
    }

    function handleTap() {
      if (isFinished) return;
      tapCount++;
      if (!startTime) {
        startTime = Date.now();
        startBrownNoise(); // 最初のタップで発動
        setInterval(update, 30);
      }
      update();
      if (Math.random() < 0.25) { document.getElementById("message").textContent = t.insults[Math.floor(Math.random() * t.insults.length)]; }
      const numEl = document.getElementById("number");
      numEl.classList.remove("tap-anim");
      void numEl.offsetWidth;
      numEl.classList.add("tap-anim");
    }

    function update() {
      if (isFinished || !startTime) return;
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / DURATION, 1);
      document.getElementById("progress-bar").style.width = (progress * 100) + "%";
      const displayValue = Math.floor(Math.min((MAX_VAL * Math.pow(progress, 0.75)) + (tapCount * 2.5), MAX_VAL));
      document.getElementById("number").textContent = displayValue.toLocaleString();
      if (progress >= 1) finish();
    }

    function finish(alreadyLocked = false) {
      isFinished = true;
      stopBrownNoise();
      if (!alreadyLocked) localStorage.setItem(LOCK_KEY, "true");
      document.getElementById("final-screen").style.display = "flex";
      const phil = document.getElementById("philosophy");
      setTimeout(() => {
        phil.style.opacity = "1";
        phil.innerHTML = t.final;
        setTimeout(() => { phil.innerHTML += t.ichie; }, 3000);
      }, 500);
    }

    // イベント登録を確実に
    document.addEventListener("mousedown", handleTap);
    document.addEventListener("touchstart", (e) => {
      if(e.cancelable) e.preventDefault();
      handleTap();
    }, { passive: false });
  </script>
</body>
</html>
